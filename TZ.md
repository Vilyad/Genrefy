# Техническое задание: Genrefy

## 1. Цель проекта
Разработка веб-сервиса для анализа музыкальных жанров и подбора референс-треков, предназначенного для начинающих музыкальных продюсеров. Сервис помогает находить релевантные примеры для изучения и понимать основные характеристики жанров через интеграцию с **Last.fm API**.

**Актуальность проекта:** Начинающим продюсерам необходимо изучать успешные треки в выбранных жанрах. Ручной поиск и анализ требует времени, тогда как автоматизированная система предоставляет структурированные данные о популярности, тегах и жанровой принадлежности треков.

## 2. Архитектурное решение

### Выбор технологии:
Используется **Last.fm API** по следующим причинам:
1. **Доступность в России:** Работает без географических ограничений
2. **Приемлемые лимиты:** 5,000 запросов в день бесплатно
3. **Богатая база данных:** Миллионы треков, артистов, тегов и жанров
4. **Стабильность:** Проверенный годами API с хорошей документацией
5. **Простота интеграции:** JSON API с понятной структурой ответов

### Хостинг: Render.com
- **Бесплатный тариф:** с поддержкой PostgreSQL
- **Автоматический деплой:** из GitHub репозитория
- **Переменные окружения:** безопасное хранение ключей
- **Спящий режим:** при неактивности более 15 минут (бесплатный тариф)
- **Время пробуждения:** ~2 минуты при первом запросе после простоя

## 3. Роли пользователей

### Гость (неавторизованный пользователь):
- Просмотр каталога музыкальных жанров
- Поиск треков и артистов через Last.fm API
- Просмотр популярных треков по жанрам
- Доступ к статистике и аналитическим графикам
- Базовый анализ характеристик жанров

### Зарегистрированный пользователь:
- Сохранение избранных жанров, треков и исполнителей
- Создание персональных коллекций (через модель Favorite)
- Расширенный профиль с аватаром и биографией (UserProfile)
- Отслеживание любимых жанров (favorite_genres)
- Получение рекомендаций на основе предпочтений

### Администратор:
- Управление контентом через Django Admin
- Обновление данных через внешние API
- Модерация пользовательского контента
- Анализ использования системы

## 4. Модели данных

### Модель 1: Genre (Музыкальный жанр)
**Описание:** Хранит информацию о музыкальных жанрах и их метаданных из Last.fm.

**Поля:**
- `name` - название жанра (CharField, 100) - уникальное
- `description` - описание жанра (TextField)
- `lastfm_tag` - соответствующий тег в Last.fm (CharField, 100)
- `lastfm_url` - страница в Last.fm (URLField)
- `track_count` - количество треков в жанре (IntegerField, default=0)
- `is_popular` - флаг популярного жанра (BooleanField, default=False)
- `created_at` / `updated_at` - временные метки

**Связи:**
- Связана с `Artist` через `ManyToManyField`
- Связана с `UserProfile` через `favorite_genres` (ManyToMany)

---

### Модель 2: Artist (Исполнитель)
**Описание:** Представляет музыкального исполнителя с данными из Last.fm.

**Поля:**
- `name` - имя исполнителя (CharField, 200)
- `lastfm_url` - страница в Last.fm (URLField)
- `lastfm_listeners` - количество слушателей (IntegerField, default=0)
- `lastfm_playcount` - количество прослушиваний (IntegerField, default=0)
- `description` - описание исполнителя (TextField)
- `image_url` - URL изображения (URLField, max_length=500)
- `genres` - жанры исполнителя (ManyToMany с Genre)
- `is_popular` - флаг популярного исполнителя (BooleanField, default=False)
- `created_at` / `updated_at` - временные метки

**Индексы:** По полям `name` и `lastfm_listeners` для оптимизации поиска

---

### Модель 3: Track (Музыкальный трек)
**Описание:** Содержит информацию о музыкальном треке с детальными данными из Last.fm.

**Поля:**
- `title` - название трека (CharField, 200)
- `artist` - исполнитель (ForeignKey к Artist)
- `lastfm_url` - страница в Last.fm (URLField)
- `lastfm_listeners` - количество слушателей (IntegerField, default=0)
- `lastfm_playcount` - количество прослушиваний (IntegerField, default=0)
- `duration` - продолжительность в секундах (IntegerField)
- `album` - название альбома (CharField, 200)
- `tags_json` - теги трека в формате JSON (TextField)
- `lastfm_data` - полные данные из Last.fm API в JSON (TextField)
- `image_url` - URL изображения (URLField, max_length=500)
- `is_reference` - флаг референс-трека (BooleanField, default=False)
- `created_at` / `updated_at` - временные метки

**Ограничения:** Уникальная связка `title` + `artist`
**Индексы:** По `title`, `lastfm_playcount`, `is_reference`

---

### Дополнительные модели:

#### Модель 4: Favorite (Избранное)
**Описание:** Хранит избранные элементы пользователя (жанры, треки, исполнители).

**Поля:**
- `user` - пользователь (ForeignKey к User)
- `item_type` - тип элемента ('genre', 'track', 'artist')
- `item_id` - ID элемента (CharField, 255)
- `created_at` - дата добавления

**Ограничения:** Уникальная связка `user` + `item_type` + `item_id`

#### Модель 5: UserProfile (Профиль пользователя)
**Описание:** Расширенный профиль пользователя с дополнительными данными.

**Поля:**
- `user` - связь OneToOne с User
- `avatar` - изображение профиля (ImageField)
- `bio` - биография (TextField, max_length=500)
- `favorite_genres` - любимые жанры (ManyToMany с Genre)
- `lastfm_username` - имя пользователя Last.fm (CharField, 100)
- `created_at` / `updated_at` - временные метки

## 5. Ключевые сценарии (User Stories)

### Базовый функционал:
1. **"Как пользователь, я хочу просматривать каталог музыкальных жанров"**
   - Страница со списком всех жанров с сортировкой по популярности
   - Карточки жанров с количеством треков и исполнителей
   - Возможность добавить жанр в избранное

2. **"Как продюсер, я хочу найти референс-треки в конкретном жанре"**
   - Детальная страница жанра со списком треков
   - Фильтрация треков по популярности (lastfm_playcount)
   - Отметка треков как "референсных" (is_reference)
   - Статистика жанра: средние показатели популярности

3. **"Как пользователь, я хочу искать треки и артистов через Last.fm API"**
   - Форма поиска по названию трека и исполнителю
   - Результаты поиска с информацией из Last.fm
   - Автоматическое сохранение найденных треков в базу данных
   - Связывание треков с жанрами на основе тегов (tags_json)

4. **"Как зарегистрированный пользователь, я хочу управлять избранным"**
   - Добавление/удаление жанров, треков и исполнителей в избранное
   - Просмотр личной коллекции избранного
   - Настройка профиля с аватаром и любимыми жанрами

5. **"Как пользователь, я хочу анализировать популярность жанров"**
   - Графики распределения треков по жанрам (Plotly)
   - Диаграммы популярности артистов (по lastfm_listeners)
   - Сравнение жанров по количеству слушателей
   - Расчет рейтинга популярности треков (calculate_popularity_score)

## 6. Технический стек

### Backend:
- **Фреймворк:** Django 4.2 (Python 3.10+)
- **База данных:** SQLite (разработка), PostgreSQL (продакшен на Render)
- **ORM:** Django ORM с расширенными запросами, индексами и ограничениями

### Внешние API:
- **Last.fm API** - получение данных о треках, артистах, жанрах
  - Методы: track.search, artist.getInfo, tag.getInfo
  - Формат: JSON
  - Аутентификация: API Key

### Аналитика и визуализация:
- **Pandas** - обработка и анализ данных о популярности
- **NumPy** - численные вычисления для статистики
- **Plotly** - интерактивные графики и визуализации

### Frontend:
- **Bootstrap 5** - адаптивный интерфейс
- **Plotly.js** - динамические графики на клиенте
- **JavaScript (ES6+)** - интерактивные элементы (анимации, избранное)

### Инфраструктура:
- **Хостинг:** Render.com (бесплатный тариф)
- **Домен:** https://genrefy.onrender.com
- **Версионный контроль:** Git, GitHub
- **Конфигурация:** python-dotenv для переменных окружения
- **Кэширование:** Файловое кэширование API запросов

## 7. Архитектура системы

### Поток данных:
```
Пользовательский запрос
        ↓
[  Форма поиска / фильтрации ]
        ↓
[    Last.fm API    ] → Получение данных о треках, артистах, тегах
        ↓
[    Django Models   ] → Сохранение и индексация данных в БД
        ↓
[  Business Logic    ] → Обработка данных, расчеты, связывание
        ↓
[      Pandas       ] → Анализ популярности, статистика
        ↓
[  Plotly + Django  ] → Генерация графиков и представление
        ↓
[  HTML Templates   ] → Рендеринг страниц с Bootstrap
        ↓
Пользовательский интерфейс
```

### Ключевые сервисы и методы:
1. **LastFMService** - работа с Last.fm API, получение и парсинг данных
2. **GenreAnalyzer** - анализ данных по жанрам, расчет статистики
3. **SearchHandler** - обработка поисковых запросов, фильтрация
4. **VisualizationEngine** - генерация графиков Plotly
5. **Track.link_genres_from_tags()** - автоматическое связывание треков с жанрами
6. **Track.calculate_popularity_score()** - расчет рейтинга популярности
7. **Artist.update_popularity()** - обновление статуса популярности

## 8. Критерии успеха

### Технические критерии:
1. **Работоспособность:** Все страницы загружаются без ошибок
2. **API интеграция:** Успешные запросы к Last.fm API
3. **Производительность:** Загрузка страниц за 2-3 секунды
4. **Данные:** Минимум 10-15 демо-записей в каждой модели
5. **Деплой:** Работающий сайт на Render.com
6. **Безопасность:** Хранение ключей в переменных окружения

### Функциональные критерии:
1. **Полный CRUD:** Создание, чтение, обновление, удаление для всех моделей
2. **Поиск:** Работающая форма поиска через Last.fm API
3. **Избранное:** Система избранного с разными типами элементов
4. **Аналитика:** Статистика и графики по жанрам и популярности
5. **Адаптивность:** Корректное отображение на мобильных устройствах
6. **Пользовательская система:** Регистрация, профили, избранное

## 9. Изменения в ходе реализации

### 20.12.2025: Первоначальная версия
- Утверждена базовая структура проекта
- Определены 3 основные модели (Genre, Artist, Track)

### 22.12.2025: Переход с Spotify API на Last.fm API
- **Причина:** Географические ограничения Spotify API
- **Решение:** Использование Last.fm API как более доступной альтернативы

### 23.12.2025: Доработка моделей данных
- Добавлены дополнительные поля для хранения данных Last.fm
- Реализована модель Favorite для системы избранного
- Добавлена модель UserProfile для расширенного профиля

### 02.01.2026: Оптимизация производительности
- Добавлены индексы базы данных для ключевых полей
- Реализованы уникальные ограничения и проверки
- Добавлены вычисляемые свойства и методы моделей

### 11.01.2026: Миграция на Render.com
- **Причина:** PythonAnywhere ограничивает бесплатные аккаунты
- **Решение:** Развертывание на Render.com с PostgreSQL
- **Особенности:** Бесплатный тариф со спящим режимом (~2 мин на пробуждение)